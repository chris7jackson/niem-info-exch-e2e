# NIEMTran Tool JSON Output Issues

## Overview
The NIEMTran tool generates NIEM JSON from NIEM XML, but the output fails JSON Schema validation against the schema generated from the same XSD files.

## Test Case
- **Source XML**: `samples/CrashDriver-cmf/CrashDriver1.xml`
- **Generated JSON**: `samples/CrashDriver-cmf/CrashDriver1.json`
- **Schema**: `samples/CrashDriver-cmf/CrashDriverSchemaSet/CrashDriver.xsd`

## Validation Error

```
anyOf error
{'j:Crash': {...}, 'j:Charge': [...], 'j:PersonChargeAssociation': [...], 'nc:Metadata': [...], 'priv:PrivacyMetadata': [...]}
is not valid under any of the given schemas

exch:CrashDriverInfo
```

## Issues Identified

### Issue 1: Metadata References Using Full Namespace URLs as Property Names

**Problem**: NIEMTran represents metadata references as nested objects with full namespace URLs as property names, instead of using the proper JSON-LD metadata reference pattern.

#### XML Source (Correct)
```xml
<j:CrashPersonInjury priv:privacyMetadataRef="PMD01 PMD02">
  <nc:InjuryDescriptionText>Broken Arm</nc:InjuryDescriptionText>
  <j:InjurySeverityCode>3</j:InjurySeverityCode>
</j:CrashPersonInjury>
```

#### NIEMTran Generated JSON (Incorrect)
```json
"j:CrashPersonInjury": [
  {
    "http://example.com/PrivacyMetadata/2.0/PrivacyMetadata": [
      {
        "@id": "#PMD01"
      },
      {
        "@id": "#PMD02"
      }
    ],
    "nc:InjuryDescriptionText": ["Broken Arm"],
    "j:InjurySeverityCode": "3"
  }
]
```

#### Expected JSON (Correct)
```json
"j:CrashPersonInjury": [
  {
    "priv:privacyMetadataRef": ["#PMD01", "#PMD02"],
    "nc:InjuryDescriptionText": ["Broken Arm"],
    "j:InjurySeverityCode": "3"
  }
]
```

**Impact**: The full namespace URL `http://example.com/PrivacyMetadata/2.0/PrivacyMetadata` is not a valid property name in the JSON Schema, causing validation failure.

---

### Issue 2: NIEM Core Metadata References Using Full Namespace URLs

**Problem**: Similar to Issue 1, but for NIEM core metadata references (`nc:metadataRef`).

#### XML Source (Correct) - Line 54
```xml
<j:Charge structures:id="CH01" nc:metadataRef="JMD01">
  <j:ChargeDescriptionText>Furious Driving</j:ChargeDescriptionText>
  <j:ChargeFelonyIndicator>false</j:ChargeFelonyIndicator>
</j:Charge>
```

#### NIEMTran Generated JSON (Incorrect)
```json
"j:Charge": [
  {
    "@id": "#CH01",
    "https://docs.oasis-open.org/niemopen/ns/model/niem-core/6.0/Metadata": [
      {
        "@id": "#JMD01"
      }
    ],
    "j:ChargeDescriptionText": ["Furious Driving"],
    "j:ChargeFelonyIndicator": [false]
  }
]
```

#### Expected JSON (Correct)
```json
"j:Charge": [
  {
    "@id": "#CH01",
    "nc:metadataRef": ["#JMD01"],
    "j:ChargeDescriptionText": ["Furious Driving"],
    "j:ChargeFelonyIndicator": [false]
  }
]
```

**Impact**: The full namespace URL `https://docs.oasis-open.org/niemopen/ns/model/niem-core/6.0/Metadata` is not a valid property name in the JSON Schema.

---

### Issue 3: PersonChargeAssociation Metadata Reference

**Problem**: Same issue as above, occurring in association elements.

#### XML Source (Correct) - Line 58
```xml
<j:PersonChargeAssociation nc:metadataRef="JMD01">
  <nc:Person structures:uri="#P01" xsi:nil="true"/>
  <j:Charge structures:ref="CH01" xsi:nil="true"/>
  <j:JuvenileAsAdultIndicator>false</j:JuvenileAsAdultIndicator>
</j:PersonChargeAssociation>
```

#### NIEMTran Generated JSON (Incorrect)
```json
"j:PersonChargeAssociation": [
  {
    "https://docs.oasis-open.org/niemopen/ns/model/niem-core/6.0/Metadata": [
      {
        "@id": "#JMD01"
      }
    ],
    "nc:Person": {"@id": "#P01"},
    "j:Charge": {"@id": "#CH01"},
    "j:JuvenileAsAdultIndicator": false
  }
]
```

#### Expected JSON (Correct)
```json
"j:PersonChargeAssociation": [
  {
    "nc:metadataRef": ["#JMD01"],
    "nc:Person": {"@id": "#P01"},
    "j:Charge": {"@id": "#CH01"},
    "j:JuvenileAsAdultIndicator": false
  }
]
```

---

## Root Cause Analysis

NIEMTran appears to be converting XML metadata reference attributes (like `nc:metadataRef`, `priv:privacyMetadataRef`) into nested objects using full namespace URLs as property names, rather than preserving the prefixed attribute names as metadata reference properties in JSON.

According to NIEM JSON-LD conventions:
- XML attributes ending in `Ref` (like `metadataRef`, `privacyMetadataRef`) should be converted to JSON properties with the same prefixed name
- The values should be arrays of reference strings (e.g., `["#PMD01", "#PMD02"]`)
- Full namespace URLs should NOT be used as property names

## Impact

1. **Validation Failure**: JSON generated by NIEMTran fails validation against JSON Schema generated from the same XSD
2. **Round-trip Incompatibility**: Cannot reliably convert XML → JSON → validation cycle
3. **Integration Issues**: Systems expecting NIEM JSON-LD conventions will fail to process metadata references correctly

## Recommendations

1. **Fix NIEMTran**: Update the XML-to-JSON conversion logic to properly handle metadata reference attributes
2. **Testing**: Add test cases that validate NIEMTran output against corresponding JSON Schemas
3. **Documentation**: Document the expected JSON-LD representation of NIEM metadata references
4. **Workaround**: Consider post-processing NIEMTran output to fix metadata references before validation

## Files Affected

- `/samples/CrashDriver-cmf/CrashDriver1.json` (lines 58-65, 76-89, 91-105)
- Any NIEM JSON files generated by NIEMTran that include metadata references

## Test Command

```bash
# Upload the schema
curl -X POST http://localhost:8000/api/schemas/upload \
  -F "files=@samples/CrashDriver-cmf/CrashDriverSchemaSet/CrashDriver.xsd" \
  ...

# Try to ingest the NIEMTran-generated JSON
curl -X POST http://localhost:8000/api/ingest/upload \
  -F "file=@samples/CrashDriver-cmf/CrashDriver1.json" \
  -F "schema_id=<schema-id>"

# Expected: Validation error with "anyOf" failure
```

## Date Reported
2025-10-28
